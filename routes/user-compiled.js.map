{"version":3,"sources":["user.js"],"names":[],"mappings":"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","file":"user-compiled.js","sourcesContent":["import express from 'express';\r\nimport { pool } from './DBconfig';\r\nimport { queryConductor } from './queryConductor';\r\nimport bcrypt from 'bcrypt';\r\n\r\nconst router = express.Router();\r\n\r\n/**\r\n * @file /routes/users.js\r\n * @brief 로그인 API\r\n * @author 이장호\r\n * @date 2017-11-14\r\n *\r\n * @body {\r\n *   account: 사용자 ID\r\n *   password: 비밀번호\r\n * }\r\n *\r\n * @sequence\r\n * 1. 입력 값이 모두 입력되었는지 확인\r\n * 2. 아이디에 해당하는 비밀번호가 일치하는지 확인\r\n * 3. 일치하는 경우 session 정보 설정\r\n *     session.account = account;\r\n *     session.name = name;\r\n *     session.nickname = nickname;\r\n *     session.divider = 1;\r\n *     session.email = email;\r\n *\r\n * @return null\r\n */\r\nrouter.get(\"/\", (req, res) => {\r\n  let sess = req.session;\r\n\r\n  sess.numbeeer = \"123\";\r\n\r\n  if (sess.id)\r\n    console.log(\"there\");\r\n  else\r\n    console.log(\"no there\");\r\n\r\n  res.json({sess});\r\n}).get('/test', (req, res) => {\r\n  let sess = req.session;\r\n\r\n  res.json(sess);\r\n})\r\n/**\r\n * @file /routes/users.js\r\n * @brief 회원가입 API\r\n * @author 이장호\r\n * @date 2017-11-14\r\n *\r\n * @body {\r\n *   account: 사용자 ID\r\n *   name: 사용자 이름\r\n *   nickname: 닉네임\r\n *   password: 비밀번호\r\n *   phone: 핸드폰 번호\r\n *   zipcode: 우편번호\r\n *   address1: 주소\r\n *   address2: 상세주소\r\n *   email: 이메일\r\n *   join_route: 가입경로\r\n *     0: normal\r\n *     1: facebook\r\n *     2: instagram\r\n *     3: kakao\r\n * }\r\n *\r\n * @sequence\r\n * 1. 입력 값이 모두 입력되었는지 확인\r\n * 2. 기존에 id 가 있는지 확인\r\n * 3. 비밀번호 Hash 생성\r\n * 4. user 테이블에 회원정보 입력\r\n * 5. session setting\r\n *\r\n * @return null\r\n */\r\n.post('/', (req, res) => {\r\n  pool.getConnection((err, connection) => {\r\n    console.log(req.session);\r\n\r\n    const { account, name, nickname, phone, zipcode, address1, address2, email, join_route } = req.body;\r\n    let { password } = req.body;\r\n\r\n    new Promise((resolve, reject) => {\r\n      if (!(account && password && name && nickname && phone && zipcode && address1 && address2 && email)) {\r\n        const msg = \"Wrong request body in # POST /user\";\r\n        reject(msg)\r\n      } else {\r\n        resolve();\r\n      }\r\n    }).then(() => {\r\n      const query = `\r\n      SELECT account\r\n        FROM user\r\n       WHERE account = \"${account}\"`;\r\n\r\n      queryConductor(connection, query).then((results) => {\r\n        if (results.length > 0) {\r\n          const msg = \"There is already account.\";\r\n          console.log(msg);\r\n          res.status(403).json({msg});\r\n        } else {\r\n          const saltRounds = 10;\r\n\r\n          bcrypt.hash(password, saltRounds, (error, hash) => {\r\n            if (error) {\r\n              const msg = \"Error occurs while CREATE HASH PASSWORD in # POST /user\";\r\n\r\n              console.log(error);\r\n              console.log(msg);\r\n              res.status(500).json({error, msg});\r\n            } else {\r\n              password = hash;\r\n\r\n              connection.beginTransaction(error => {\r\n                if (error) {\r\n                  const msg = \"Error occurs while TRANSACTION in # POST /user\";\r\n                  console.log(error);\r\n                  console.log(msg);\r\n                  res.status(500).json({error, msg});\r\n                } else {\r\n                  // SHA1(\"test6\")\r\n                  // a66df261120b6c2311c6ef0b1bab4e583afcbcc0\r\n\r\n                  const query = `\r\n                  INSERT INTO user (\r\n                    account,\r\n                    name,\r\n                    nickname,\r\n                    password,\r\n                    divider,\r\n                    phone,\r\n                    zipcode,\r\n                    address1,\r\n                    address2,\r\n                    email,\r\n                    enroll_date,\r\n                    join_route\r\n                  ) VALUES (\r\n                    \"${account}\",\r\n                    \"${name}\",\r\n                    \"${nickname}\",\r\n                    \"${password}\",\r\n                    1,\r\n                    \"${phone}\",\r\n                    \"${zipcode}\",\r\n                    \"${address1}\",\r\n                    \"${address2}\",\r\n                    \"${email}\",\r\n                    now(),\r\n                    ${join_route}\r\n                  )`;\r\n\r\n                  queryConductor(connection, query).then(() => {\r\n                    connection.commit(error => {\r\n                      if (error) {\r\n                        const msg = \"Error occurs while COMMIT in # POST /user\";\r\n\r\n                        console.log(error);\r\n                        console.log(msg);\r\n                        connection.rollback(() => {\r\n                          connection.release();\r\n                          res.status(500).json({error, msg});\r\n                        })\r\n                      } else {\r\n                        let { session } = req;\r\n                        session.account = account;\r\n                        session.name = name;\r\n                        session.nickname = nickname;\r\n                        session.divider = 1;\r\n                        session.email = email;\r\n\r\n                        connection.release();\r\n                        res.end();\r\n                      }\r\n                    })\r\n                  }, error => {\r\n                    const msg = \"Error occurs while INSERT INTO user in # POST /user\";\r\n\r\n                    console.log(error);\r\n                    console.log(msg);\r\n                    connection.rollback(() => {\r\n                      connection.release();\r\n                      res.status(500).json({error, msg})\r\n                    })\r\n                  })\r\n                }\r\n              })\r\n            }\r\n          })\r\n        }\r\n      })\r\n    }).catch((error) => {\r\n      console.log(error);\r\n      res.status(500).json({error});\r\n    });\r\n  })\r\n});\r\n\r\nmodule.exports = router;"]}